<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Lifestyle Shirva - Scratch & Win</title>
<style>
body, html { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#f0f0f0; }
header { background:#4CAF50; color:white; padding:15px; text-align:center; font-size:1.8rem; font-weight:bold; }
.dashboard { background:white; padding:15px; border-radius:16px; width:95%; max-width:360px; text-align:center; margin:20px auto; }
.dashboard input, .dashboard button { width:100%; padding:12px; margin:8px 0; border-radius:10px; font-size:1rem; }
.dashboard button { border:none; color:white; background:#4CAF50; font-weight:bold; }
#firstScreenConditionBox { display:none; margin-top:15px; padding:12px; background:#FFF8DC; border:2px solid #FFD700; border-radius:12px; text-align:left; }
#firstScreenConditionBox span { display:block; margin:5px 0; }
.scratch-container { display:none; flex-direction:column; align-items:center; background:radial-gradient(circle,#FFFAF0,#FF6347); border-radius:20px; padding:15px; max-width:420px; margin:auto; }
#scratchCanvas { width:300px; height:300px; border-radius:50%; }
#offer { position:absolute; width:300px; height:300px; top:0; left:50%; transform:translateX(-50%); display:flex; align-items:center; justify-content:center; border-radius:50%; background:#FFF8DC; font-size:2rem; }
#afterScratchConditionBox { display:none; margin-top:15px; padding:15px; border:3px solid gold; border-radius:12px; background:white; text-align:center; }
</style>
</head>
<body>

<header>Welcome To Lifestyle Shirva!</header>

<!-- First Screen -->
<div class="dashboard" id="firstScreen">
  <input type="text" id="billNo" placeholder="Enter Your Bill Number">
  <button onclick="proceed()">Proceed</button>
  <div id="msg"></div>
  <div id="firstScreenConditionBox">
    <span id="condCustName"></span>
    <span id="condBillNo"></span>
    <span id="condBillAmt"></span>
    <span id="condCouponCode"></span>
    <span id="condWinningGift"></span>
  </div>
</div>

<!-- Second Screen -->
<div class="scratch-container" id="secondScreen">
  <h2>Scratch & Win üèÜ</h2>
  <div style="position:relative;">
    <canvas id="scratchCanvas" width="300" height="300"></canvas>
    <div id="offer">üéâ Scratch Me üéâ</div>
  </div>
  <div id="afterScratchConditionBox">
    <h3>üéâ Congratulations üéâ</h3>
    <span id="afterCustName"></span>
    <span id="afterBillNo"></span>
    <span id="afterBillAmt"></span>
    <span id="winningInfo"></span>
    <span id="couponCodeInfo"></span>
    <span id="scratchDateTime"></span>
  </div>
</div>

<script>
let usedBills = JSON.parse(localStorage.getItem('usedBills')||'[]');
function saveUsedBills(){ localStorage.setItem('usedBills', JSON.stringify(usedBills)); }

// ‚úÖ Fixed to support bills.json structure
async function getCustomerData(billNo){
  const res = await fetch("bills.json");
  const data = await res.json();
  const bills = data.bills || data;   // support wrapped JSON or direct array
  const customer = bills.find(c => c.billNo === billNo);

  if (customer) {
    if (customer.payable && !customer.amount) {
      customer.amount = parseFloat(customer.payable);
    }
  }
  return customer;
}

async function proceed(){
  const billNo=document.getElementById('billNo').value.trim();
  const msg=document.getElementById('msg');
  const condBox=document.getElementById('firstScreenConditionBox');
  msg.innerHTML="";

  if(!billNo){ msg.innerHTML="‚ö†Ô∏è Enter Bill Number"; return; }

  let used=usedBills.find(b=>b.billNo===billNo);
  if(used){ 
    condBox.style.display='block';
    document.getElementById('condCustName').innerText=`Customer: ${used.name||'-'} (${used.mobile||'-'})`;
    document.getElementById('condBillNo').innerText=`Bill: ${used.billNo}`;
    document.getElementById('condBillAmt').innerText=`Amount: ‚Çπ${used.billAmt}`;
    document.getElementById('condCouponCode').innerText=`Coupon: ${used.coupon}`;
    document.getElementById('condWinningGift').innerText=`Gift: ${used.gift}`;
    msg.innerHTML="‚ùå Already used!";
    return;
  }

  const customer=await getCustomerData(billNo);
  if(!customer){ msg.innerHTML="‚ùå Bill not found"; return; }

  usedBills.push({billNo,name:customer.name,billAmt:customer.amount,mobile:customer.mobile,gift:null,coupon:null,dateTime:null});
  saveUsedBills();

  condBox.style.display='block';
  document.getElementById('condCustName').innerText=`Customer: ${customer.name||'-'} (${customer.mobile||'-'})`;
  document.getElementById('condBillNo').innerText=`Bill: ${billNo}`;
  document.getElementById('condBillAmt').innerText=`Amount: ‚Çπ${customer.amount}`;
  document.getElementById('condCouponCode').innerText="Coupon: -";
  document.getElementById('condWinningGift').innerText="Gift: -";

  let goBtn=document.createElement("button");
  goBtn.innerText="Go to Scratch";
  goBtn.onclick=()=>{
    document.getElementById('firstScreen').style.display="none";
    document.getElementById('secondScreen').style.display="flex";
  };
  condBox.appendChild(goBtn);
}

// Scratch Logic
const canvas=document.getElementById('scratchCanvas');
const ctx=canvas.getContext('2d');
let revealed=false,isDrawing=false;
ctx.fillStyle='silver'; ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.font='bold 20px Arial'; ctx.fillStyle='black'; ctx.textAlign='center';
ctx.fillText('SCRATCH üéâ',150,150);

canvas.addEventListener('pointerdown',()=>isDrawing=true);
canvas.addEventListener('pointermove',e=>{if(isDrawing&&!revealed)scratch(e);});
canvas.addEventListener('pointerup',()=>{if(!revealed){startCelebration();}isDrawing=false;});

function getPointerPos(e){const r=canvas.getBoundingClientRect();return{x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,y:(e.touches?e.touches[0].clientY:e.clientY)-r.top};}
function scratch(e){const p=getPointerPos(e);ctx.globalCompositeOperation='destination-out';ctx.beginPath();ctx.arc(p.x,p.y,20,0,Math.PI*2);ctx.fill();}

function startCelebration(){
  let cust=usedBills[usedBills.length-1];
  let amt=cust.billAmt; let gifts=[];
  if(amt>=1000 && amt<1500) gifts=['üí∞30‚Çπ Cashback','üí∞40‚Çπ Cashback','üí∞50‚Çπ Cashback'];
  else if(amt>=1500 && amt<2000) gifts=['üí∞20‚Çπ Cashback','üí∞30‚Çπ Cashback','üí∞40‚Çπ Cashback','üí∞50‚Çπ Cashback'];
  else if(amt>=2000 && amt<2500) gifts=['üí∞30‚Çπ Cashback','üí∞40‚Çπ Cashback','üí∞50‚Çπ Cashback','üí∞60‚Çπ Cashback'];
  else if(amt>=2500 && amt<3000) gifts=['üí∞40‚Çπ Cashback','üí∞50‚Çπ Cashback','üí∞70‚Çπ Cashback','üí∞80‚Çπ Cashback'];
  else if(amt>=3000) gifts=['üí∞50‚Çπ Cashback','üí∞70‚Çπ Cashback','üí∞90‚Çπ Cashback','üí∞100‚Çπ Cashback'];
  const gift=gifts[Math.floor(Math.random()*gifts.length)];
  revealFull(gift);
}

function generateCoupon(){return 'LS-'+Math.random().toString(36).substring(2,10).toUpperCase();}
function getNow(){return new Date().toLocaleString();}

function revealFull(gift,existingCoupon=null,existingDate=null){
  revealed=true; ctx.clearRect(0,0,canvas.width,canvas.height);
  document.getElementById('offer').innerText=gift;
  let cust=usedBills[usedBills.length-1];
  const code=existingCoupon||generateCoupon();
  const dt=existingDate||getNow();
  document.getElementById('afterCustName').innerText=`Customer: ${cust.name||'-'}`;
  document.getElementById('afterBillNo').innerText=`Bill No: ${cust.billNo}`;
  document.getElementById('afterBillAmt').innerText=`Amount: ‚Çπ${cust.billAmt}`;
  document.getElementById('winningInfo').innerText=`You Won: ${gift}`;
  document.getElementById('couponCodeInfo').innerText=`Code: ${code}`;
  document.getElementById('scratchDateTime').innerText=`Date: ${dt}`;
  document.getElementById('afterScratchConditionBox').style.display='block';
  if(!cust.gift){cust.gift=gift;cust.coupon=code;cust.dateTime=dt;saveUsedBills();}
}
</script>
</body>
</html>
